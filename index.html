<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Stranger Things: Pedra Branca Invertida</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Estilo geral */
body, html {
  margin: 0;
  padding: 0;
  background: black;
  color: white;
  font-family: Arial, sans-serif;
  overflow: hidden;
}
#loading-screen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: black;
}
#loading-bar {
  width: 80%;
  height: 20px;
  background: #333;
  margin-top: 20px;
  border-radius: 10px;
  overflow: hidden;
}
#loading-fill {
  height: 100%;
  width: 0;
  background: red;
  transition: width 0.3s;
}
#start-btn {
  padding: 10px 20px;
  margin-top: 20px;
  font-size: 18px;
  background: red;
  border: none;
  color: white;
  cursor: pointer;
  display: none;
}
#call-screen {
  display: none;
  text-align: center;
  padding-top: 20px;
}
#compass {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 120px;
  height: 120px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>

<!-- Tela de carregamento -->
<div id="loading-screen">
  <img src="https://upload.wikimedia.org/wikipedia/commons/3/38/Stranger_Things_logo.png" width="300">
  <div id="loading-bar"><div id="loading-fill"></div></div>
  <button id="start-btn">Iniciar Jogo</button>
</div>

<!-- Tela de ligaÃ§Ã£o -->
<div id="call-screen">
  <h2>ðŸ“ž Dustin estÃ¡ ligando...</h2>
  <audio id="dustin-audio" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2b07d58d14.mp3" preload="auto"></audio>
</div>

<!-- BÃºssola -->
<svg id="compass" viewBox="0 0 100 100">
  <circle cx="50" cy="50" r="48" stroke="white" stroke-width="2" fill="none"/>
  <line id="needle" x1="50" y1="50" x2="50" y2="10" stroke="red" stroke-width="3"/>
</svg>

<!-- Cena AR -->
<a-scene mindar-image="imageTargetSrc: https://raw.githubusercontent.com/MindAR-js/aframe-examples/master/assets/card-example/card.mind;"
         vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
  <a-assets>
    <a-asset-item id="bikeModel" src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"></a-asset-item>
  </a-assets>
  <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
  <a-entity mindar-image-target="targetIndex: 0">
    <a-gltf-model src="#bikeModel" scale="0.5 0.5 0.5" position="0 -0.25 0"></a-gltf-model>
  </a-entity>
</a-scene>

<script>
// ===== SERVICE WORKER EMBUTIDO =====
if ('serviceWorker' in navigator) {
  const swCode = `
    self.addEventListener('install', e => {
      e.waitUntil(caches.open('st-ar-v1').then(cache => {
        return cache.addAll(['.']);
      }));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(caches.match(e.request).then(resp => resp || fetch(e.request)));
    });
  `;
  const blob = new Blob([swCode], {type: 'application/javascript'});
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL);
}

// ===== TELA DE CARREGAMENTO =====
let progress = 0;
const fill = document.getElementById('loading-fill');
const startBtn = document.getElementById('start-btn');
const loadingInterval = setInterval(() => {
  progress += 10;
  fill.style.width = progress + '%';
  if (progress >= 100) {
    clearInterval(loadingInterval);
    startBtn.style.display = 'block';
  }
}, 200);

startBtn.addEventListener('click', () => {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('call-screen').style.display = 'block';
  document.getElementById('dustin-audio').play();
});

// ===== BÃšSSOLA + GEOLOCALIZAÃ‡ÃƒO =====
const targetLat = -27.62172576455045;
const targetLon = -48.6799944586445;

if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const {latitude, longitude} = pos.coords;
    const dist = getDistance(latitude, longitude, targetLat, targetLon);
    if (dist < 0.01) {
      if (navigator.vibrate) navigator.vibrate(500);
      alert("VocÃª chegou Ã  Floresta das Trevas! Aponte a cÃ¢mera para o marcador para encontrar a bicicleta do Will.");
    }
  });
}

window.addEventListener('deviceorientation', e => {
  const needle = document.getElementById('needle');
  if (e.absolute && e.alpha !== null) {
    needle.setAttribute('transform', \`rotate(\${360 - e.alpha} 50 50)\`);
  }
});

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}
</script>

</body>
</html>