<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Stranger Things — AR Game</title>
  <script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#000814;color:#e6eef8;font-family:Arial}
    #loading{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:rgba(0,0,0,0.9);z-index:9999}
    #startBtn{padding:12px 24px;font-size:18px;background:#ef4444;border:none;color:#fff;cursor:pointer}
    #arrowHud{position:fixed;right:18px;bottom:18px;width:100px;height:100px;border-radius:50%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:998}
    #arrowHud svg{width:48px;height:48px;transform-origin:center center;transition:transform 200ms linear}
    #distanceText{font-size:12px;color:#94a3b8;margin-top:6px}
    #msg{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#081225;padding:10px 14px;border-radius:8px;color:#dbeafe;display:none;z-index:999}
  </style>
</head>
<body>
  <div id="loading">
    <img src="https://riverlanteixeira.github.io/grok/assets/img/stranger-things-logo.png" width="260">
    <button id="startBtn">Iniciar o Jogo</button>
  </div>
  <div id="msg"></div>
  <div id="arrowHud">
    <svg viewBox="0 0 24 24" id="arrowSvg"><path d="M12 2 L15 10 H13 V22 H11 V10 H9 L12 2 Z" fill="#fff"/></svg>
    <div id="distanceText">-- m</div>
  </div>
  <a-scene embedded vr-mode-ui="enabled:false" mindar-image="imageTargetSrc: https://riverlanteixeira.github.io/grok/assets/mind/targets.mind; uiLoading:none; uiScanning:none;" arjs="sourceType: webcam; debugUIEnabled: false;" device-orientation-permission-ui="enabled:false">
    <a-assets timeout="300000">
      <audio id="audioIntro" src="https://riverlanteixeira.github.io/grok/assets/audio/dustin-intro.mp3"></audio>
      <audio id="audio1" src="https://riverlanteixeira.github.io/grok/assets/audio/dustin-missao-1-completa.mp3"></audio>
      <a-asset-item id="bicicletaModel" src="https://riverlanteixeira.github.io/grok/assets/models/bicicleta-will.glb"></a-asset-item>
    </a-assets>
    <!-- MindAR Target -->
    <a-entity mindar-image-target="targetIndex:0">
      <a-plane id="mindPlane" position="0 0 0" rotation="-90 0 0" width="1.6" height="0.9" material="shader:flat; src: #luzesGif; transparent:true;"></a-plane>
    </a-entity>
    <!-- Hiro fallback -->
    <a-marker preset="hiro" id="hiroMarker">
      <a-plane id="hiroPlane" position="0 0 0" rotation="-90 0 0" width="1.6" height="0.9" material="shader:flat; src: #luzesGif; transparent:true;"></a-plane>
    </a-marker>
    <a-entity id="bicicletaEntity" gltf-model="#bicicletaModel" scale="0.5 0.5 0.5" position="0 -0.6 -1" visible="false" class="collectable"></a-entity>
    <a-entity camera id="cam"></a-entity>
  </a-scene>
<script>
  const startBtn = document.getElementById('startBtn');
  const loading = document.getElementById('loading');
  const msg = document.getElementById('msg');
  const arrowHud = document.getElementById('arrowHud');
  const arrowSvg = document.getElementById('arrowSvg');
  const distText = document.getElementById('distanceText');
  const audioIntro = document.getElementById('audioIntro');
  const bicicleta = document.getElementById('bicicletaEntity');
  const MISSIONS = {1:{name:"Floresta das Trevas",lat:-27.63985135643477,lon:-48.66777779450669,radius:10}};
  let currentMission=0, watchId=null, lastPos=null, heading=0;

  function showMsg(t){ msg.innerText=t; msg.style.display='block'; setTimeout(()=>msg.style.display='none', 3000); }
  startBtn.addEventListener('click', async ()=>{
    loading.style.display='none';
    showMsg('Preparando...');
    // orientation permission
    if (typeof DeviceOrientationEvent.requestPermission==='function') try{ await DeviceOrientationEvent.requestPermission(); }catch{}
    // play intro
    audioIntro.play().catch(()=>{});
    currentMission=1; startGPS(); arrowHud.style.display='flex';
    document.querySelector('a-scene').enterVR().catch(()=>{});
  });

  function startGPS(){
    if (!navigator.geolocation) {alert('GPS não disponível');return;}
    watchId = navigator.geolocation.watchPosition(p => {
      lastPos = p.coords;
      const d = distance(p.coords.latitude,p.coords.longitude,MISSIONS[1].lat,MISSIONS[1].lon);
      distText.innerText = d.toFixed(0) + ' m';
      if (d<=MISSIONS[1].radius){
        if (navigator.vibrate) navigator.vibrate(300);
        arrowHud.style.display='none';
        showMsg('Você chegou! Bicicleta aparece na tela — toque para coletar.');
        bicicleta.setAttribute('visible','true');
        BMP();
      }
    }, e=>console.warn(e),{enableHighAccuracy:true});
  }

  function distance(lat1,lon1,lat2,lon2){
    const R=6371000;const φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180;
    const Δφ=(lat2-lat1)*Math.PI/180, Δλ=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  bicicleta.addEventListener('click', ()=>{
    if (currentMission===1){
      bicicleta.setAttribute('visible','false');
      showMsg('Missão concluída! (implementar próxima etapa...)');
    }
  });

  window.addEventListener('deviceorientation', e=>{
    if (e.alpha!=null){ heading = 360 - e.alpha; arrowSvg.style.transform = `rotate(${heading}deg)`; }
  });
</script>
</body>
</html>