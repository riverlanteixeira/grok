<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stranger Things AR Game</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #hud {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="hud">Carregando...</div>

<a-scene embedded vr-mode-ui="enabled: false" renderer="colorManagement: true" arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
        <a-asset-item id="bike-model" src="models/bike.glb"></a-asset-item>
        <a-asset-item id="demogorgon-model" src="models/demogorgon.glb"></a-asset-item>
        <a-asset-item id="walkie-model" src="models/walkie.glb"></a-asset-item>
        <a-asset-item id="axe-model" src="models/axe.glb"></a-asset-item>
        <a-asset-item id="alphabet-model" src="models/alphabet.glb"></a-asset-item>
        <a-asset-item id="compass-model" src="models/compass.glb"></a-asset-item>
        <a-asset-item id="light-model" src="models/light.glb"></a-asset-item>
    </a-assets>

    <!-- Câmera do AR.js -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- Seta direcional -->
    <a-entity id="direction-arrow"
              geometry="primitive: cone; radiusBottom: 0.05; radiusTop: 0; height: 0.2"
              material="color: yellow; opacity: 0.85"
              position="0 -0.3 -1"
              rotation="0 0 0"
              visible="false">
    </a-entity>
</a-scene>

<script>
    const sceneEl = document.querySelector('a-scene');
    const hud = document.getElementById('hud');

    const objects = [
        { id: 'bike', name: 'Bicicleta', lat: -23.561, lng: -46.656 },
        { id: 'demogorgon', name: 'Demogorgon', lat: -23.562, lng: -46.657 },
        { id: 'walkie', name: 'Walkie Talkie', lat: -23.563, lng: -46.658 },
        { id: 'axe', name: 'Machado', lat: -23.564, lng: -46.659 },
        { id: 'alphabet', name: 'Alfabeto', lat: -23.565, lng: -46.660 },
        { id: 'compass', name: 'Bússola', lat: -23.566, lng: -46.661 },
        { id: 'light', name: 'Luz', lat: -23.567, lng: -46.662 }
    ];

    let currentObjectIndex = 0;
    let locationUnlocked = Array(objects.length).fill(false);
    let currentLocation = { lat: null, lng: null };

    const PROXIMITY_RADIUS = 10; // metros

    // Calcula o rumo entre dois pontos GPS
    function calculateBearing(lat1, lon1, lat2, lon2) {
        const toRad = deg => deg * Math.PI / 180;
        const toDeg = rad => rad * 180 / Math.PI;
        const dLon = toRad(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRad(lat2));
        const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                  Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
        let brng = toDeg(Math.atan2(y, x));
        return (brng + 360) % 360;
    }

    // Distância em metros entre dois pontos GPS
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const toRad = deg => deg * Math.PI / 180;
        const φ1 = toRad(lat1);
        const φ2 = toRad(lat2);
        const Δφ = toRad(lat2 - lat1);
        const Δλ = toRad(lon2 - lon1);
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function checkProximityToLocations() {
        if (currentLocation.lat === null) return;

        const currentObject = objects[currentObjectIndex];
        const dist = getDistance(
            currentLocation.lat, currentLocation.lng,
            currentObject.lat, currentObject.lng
        );

        const arrow = document.getElementById('direction-arrow');

        if (!locationUnlocked[currentObjectIndex]) {
            const bearing = calculateBearing(
                currentLocation.lat, currentLocation.lng,
                currentObject.lat, currentObject.lng
            );

            const cameraYaw = sceneEl.camera.el.object3D.rotation.y * (180 / Math.PI);
            const relativeBearing = bearing - cameraYaw;

            arrow.setAttribute('rotation', { x: -90, y: relativeBearing, z: 0 });
            arrow.setAttribute('visible', true);

            hud.textContent = `Próximo: ${currentObject.name} - Distância: ${dist.toFixed(1)}m`;
        } else {
            arrow.setAttribute('visible', false);
        }

        if (dist <= PROXIMITY_RADIUS && !locationUnlocked[currentObjectIndex]) {
            locationUnlocked[currentObjectIndex] = true;
            hud.textContent = `${currentObject.name} desbloqueado!`;
            spawnObject(currentObject.id);
        }
    }

    function spawnObject(objectId) {
        let scaleValue = 1;
        if (objectId === 'bike') scaleValue = 0.4;
        if (objectId === 'demogorgon') scaleValue = 0.8;

        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', `#${objectId}-model`);
        model.setAttribute('scale', `${scaleValue} ${scaleValue} ${scaleValue}`);
        model.setAttribute('gps-entity-place', `latitude: ${currentLocation.lat}; longitude: ${currentLocation.lng}`);
        model.setAttribute('animation-mixer', '');
        sceneEl.appendChild(model);

        currentObjectIndex++;
        if (currentObjectIndex >= objects.length) {
            hud.textContent = 'Parabéns! Você encontrou todos os itens!';
        }
    }

    // GPS
    if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition((pos) => {
            currentLocation.lat = pos.coords.latitude;
            currentLocation.lng = pos.coords.longitude;
            checkProximityToLocations();
        }, (err) => {
            console.error(err);
            hud.textContent = 'Erro ao obter localização';
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 27000 });
    } else {
        hud.textContent = 'GPS não suportado';
    }
</script>
</body>
</html>
